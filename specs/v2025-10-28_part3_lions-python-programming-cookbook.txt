date: 2025-10-30
title: Lion's Chat-GPT Python Programming Cookbook


== Cookbook ==
date: 2025-10-30


               ========================================
                            Atomic Writes
               ========================================

# These functions ensure that no partially-written file ever appears on disk.
# Data is written to a temporary file first, then atomically moved into place.
# Safe for use in programs that may crash or be interrupted mid-write.


def prepare_write():
    """
    Create and return a temporary UTF-8 text file for writing.

    Side Effects:
        Sets g["tmpfile"] to the opened NamedTemporaryFile.

    Returns:
        NamedTemporaryFile: The open temporary file object in text mode.
    """
    g["tmpfile"] = tempfile.NamedTemporaryFile(delete=False, mode="w", encoding="utf-8")
    return g["tmpfile"]


def prepare_binarywrite():
    """
    Create and return a temporary binary file for writing.

    Side Effects:
        Sets g["tmpfile"] to the opened NamedTemporaryFile.

    Returns:
        NamedTemporaryFile: The open temporary file object in binary mode.
    """
    g["tmpfile"] = tempfile.NamedTemporaryFile(delete=False, mode="wb")
    return g["tmpfile"]


def complete_write(p):
    """
    Close the active temp file and move it to the path `p`.

    The destination is overwritten if it exists.

    Args:
        p (Path): Destination path for the completed temp file.
    """
    assert isinstance(p, Path)
    g["tmpfile"].close()
    p.parent.mkdir(parents=True, exist_ok=True)
    shutil.move(g["tmpfile"].name, str(p))
